<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rossmann Envanter Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .group-header {
            background-color: #f1f5f9;
            font-weight: 600;
            cursor: pointer;
        }
        .group-header:hover {
            background-color: #e2e8f0;
        }
        .group-content {
            transition: all 0.3s ease;
        }
        .group-collapsed .group-content {
            display: none;
        }
        /* Giriş butonu animasyonları */
        .login-btn {
            transition: all 0.2s ease;
        }
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Giriş Ekranı -->
    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 overflow-hidden">
            <div class="bg-red-700 p-6 text-center">
                <h2 class="text-2xl font-bold text-white">Envanter Sistemi</h2>
                <p class="text-red-100 mt-1 text-sm">Lütfen giriş yapacak personeli seçiniz</p>
            </div>
            
            <div class="p-8">
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="window.loginAs('Mustafa Ay')" class="login-btn w-full flex items-center justify-between px-6 py-4 bg-white border border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 group">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 group-hover:bg-red-100 group-hover:text-red-600 transition-colors">
                                <span class="font-bold text-lg">MA</span>
                            </div>
                            <span class="ml-4 font-semibold text-gray-700 group-hover:text-gray-900">Mustafa Ay</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:text-red-500"></i>
                    </button>

                    <button onclick="window.loginAs('Doğan Çevik')" class="login-btn w-full flex items-center justify-between px-6 py-4 bg-white border border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 group">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 group-hover:bg-red-100 group-hover:text-red-600 transition-colors">
                                <span class="font-bold text-lg">DÇ</span>
                            </div>
                            <span class="ml-4 font-semibold text-gray-700 group-hover:text-gray-900">Doğan Çevik</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:text-red-500"></i>
                    </button>

                    <button onclick="window.loginAs('Samet Kandemir')" class="login-btn w-full flex items-center justify-between px-6 py-4 bg-white border border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 group">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 group-hover:bg-red-100 group-hover:text-red-600 transition-colors">
                                <span class="font-bold text-lg">SK</span>
                            </div>
                            <span class="ml-4 font-semibold text-gray-700 group-hover:text-gray-900">Samet Kandemir</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:text-red-500"></i>
                    </button>

                    <button onclick="window.loginAs('M. Arif Çoban')" class="login-btn w-full flex items-center justify-between px-6 py-4 bg-white border border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 group">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 group-hover:bg-red-100 group-hover:text-red-600 transition-colors">
                                <span class="font-bold text-lg">MA</span>
                            </div>
                            <span class="ml-4 font-semibold text-gray-700 group-hover:text-gray-900">M. Arif Çoban</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:text-red-500"></i>
                    </button>

                    <button onclick="window.loginAs('Şükür Yıldız')" class="login-btn w-full flex items-center justify-between px-6 py-4 bg-white border border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 group">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 group-hover:bg-red-100 group-hover:text-red-600 transition-colors">
                                <span class="font-bold text-lg">ŞY</span>
                            </div>
                            <span class="ml-4 font-semibold text-gray-700 group-hover:text-gray-900">Şükür Yıldız</span>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:text-red-500"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ana Uygulama -->
    <div id="appScreen" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">

        <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
            <div>
                <div class="flex items-center gap-2">
                    <h1 class="text-3xl font-bold text-gray-900">Envanter Sistemi</h1>
                    <button id="undoButton" class="text-gray-500 hover:text-gray-700 disabled:text-gray-300 disabled:cursor-not-allowed transition-colors p-2 rounded-full hover:bg-gray-100" title="Geri Al" disabled>
                        <i class="fas fa-undo"></i>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-1">Rossmann Envanter Ve Stok Takip Sistemi</p>
            </div>
            <div class="flex items-center gap-4 mt-2 sm:mt-0">
                <div id="userInfo" class="text-sm text-gray-700 bg-blue-50 px-3 py-1 rounded-md flex items-center gap-2 border border-blue-100">
                    <div class="w-6 h-6 rounded-full bg-blue-200 flex items-center justify-center text-blue-700 text-xs font-bold">
                        <i class="fas fa-user"></i>
                    </div>
                    <span id="currentUser" class="font-medium">Kullanıcı</span>
                </div>
                <div id="statusBox" class="bg-yellow-50 border border-yellow-200 rounded px-3 py-2 text-sm">
                    <i class="fas fa-circle-notch fa-spin text-yellow-600"></i>
                    <span class="font-medium">Durum: </span>
                    <span id="connectionStatus" class="font-mono">Bağlanıyor...</span>
                </div>
                <button onclick="location.reload()" class="text-gray-500 hover:text-gray-700 text-sm underline" title="Sayfayı Yenile">
                    Çıkış
                </button>
            </div>
        </header>

        <!-- Gelişmiş Filtreleme -->
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
            <div class="flex flex-col md:flex-row gap-3">
                <div class="relative flex-grow">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fas fa-search text-gray-400"></i>
                    </span>
                    <input type="search" id="searchInput" placeholder="Ara (Envanter No, Model, Seri No...)" class="w-full pl-10 pr-4 py-2.5 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200">
                </div>
                
                <div class="flex-shrink-0 flex gap-3">
                    <button id="filterButton" class="w-full md:w-auto flex items-center justify-center gap-2 bg-gray-600 hover:bg-gray-700 text-white font-medium py-2.5 px-4 rounded-md transition duration-200 shadow-sm">
                        <i class="fas fa-filter"></i>
                        <span>Filtreler</span>
                    </button>
                    <button id="exportCsvButton" class="w-full md:w-auto flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-md transition duration-200 shadow-sm">
                        <i class="fas fa-file-csv"></i>
                        <span>CSV Dışa Aktar</span>
                    </button>
                    <button id="importExcelButton" class="w-full md:w-auto flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 text-white font-medium py-2.5 px-4 rounded-md transition duration-200 shadow-sm">
                        <i class="fas fa-file-excel"></i>
                        <span>Excel İçe Aktar</span>
                    </button>
                    <button id="openModalButton" class="w-full md:w-auto flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-md transition duration-200 shadow-sm">
                        <i class="fas fa-plus"></i>
                        <span>Yeni Kayıt Ekle</span>
                    </button>
                </div>
            </div>
            
            <!-- Gelişmiş Filtreler -->
            <div id="advancedFilters" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cihaz Türü</label>
                    <select id="filterCihazTuru" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white" multiple>
                        <!-- Dinamik olarak doldurulacak -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Durum</label>
                    <select id="filterDurum" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white" multiple>
                        <option value="Yeni">Yeni</option>
                        <option value="Kullanımda">Kullanımda</option>
                        <option value="Arızalı">Arızalı</option>
                        <option value="Bakımda">Bakımda</option>
                        <option value="Stokta">Stokta</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lokasyon</label>
                    <select id="filterLokasyon" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white" multiple>
                        <!-- Dinamik olarak doldurulacak -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teslim Alan</label>
                    <select id="filterTeslimAlan" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white" multiple>
                        <!-- Dinamik olarak doldurulacak -->
                    </select>
                </div>
                <div class="md:col-span-2 lg:col-span-4 flex justify-between">
                    <div class="flex items-center">
                        <input type="checkbox" id="groupByCihazTuru" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="groupByCihazTuru" class="ml-2 text-sm text-gray-700">Cihaz Türüne Göre Grupla</label>
                    </div>
                    <div class="flex gap-2">
                        <button id="clearFiltersButton" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-md transition duration-200">
                            Filtreleri Temizle
                        </button>
                        <button id="applyFiltersButton" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                            Filtreleri Uygula
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full min-w-max table-auto">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Envanter No</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Cihaz Türü</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Marka / Model</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Seri No</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Durum</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Lokasyon</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Teslim Alan</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Giriş Tarihi</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">İşlem Yapan</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Eylemler</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="10" class="px-4 py-6 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Veriler yükleniyor...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-4 text-center text-xs text-gray-500">
            <i class="fas fa-info-circle"></i> Bu sistem paylaşımlıdır. Tüm kullanıcılar verileri gerçek zamanlı olarak görür.
        </div>
    </div>

    <!-- Yeni Kayıt / Düzenleme Modalı -->
    <div id="itemModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 transform transition-all scale-95 opacity-0" id="modalContent">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900" id="modalTitle">Yeni Envanter Kaydı</h3>
                <button id="closeModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <form id="itemForm" class="p-6 space-y-4">
                <input type="hidden" id="editingItemId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="envanterNo" class="block text-sm font-medium text-gray-700 mb-1">Envanter No *</label>
                        <input type="text" id="envanterNo" list="envanterNoList" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" required>
                        <datalist id="envanterNoList"></datalist>
                    </div>
                    <div>
                        <label for="cihazTuru" class="block text-sm font-medium text-gray-700 mb-1">Cihaz Türü</label>
                        <input type="text" id="cihazTuru" list="cihazTuruList" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <datalist id="cihazTuruList"></datalist>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="markaModel" class="block text-sm font-medium text-gray-700 mb-1">Marka / Model</label>
                        <input type="text" id="markaModel" list="markaModelList" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <datalist id="markaModelList"></datalist>
                    </div>
                    <div>
                        <label for="seriNo" class="block text-sm font-medium text-gray-700 mb-1">Seri No</label>
                        <input type="text" id="seriNo" list="seriNoList" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <datalist id="seriNoList"></datalist>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="durum" class="block text-sm font-medium text-gray-700 mb-1">Durum</label>
                        <select id="durum" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                            <option value="Yeni">Yeni</option>
                            <option value="Kullanımda">Kullanımda</option>
                            <option value="Arızalı">Arızalı</option>
                            <option value="Bakımda">Bakımda</option>
                            <option value="Stokta">Stokta</option>
                        </select>
                    </div>
                    <div>
                        <label for="lokasyon" class="block text-sm font-medium text-gray-700 mb-1">Lokasyon</label>
                        <input type="text" id="lokasyon" list="lokasyonList" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <datalist id="lokasyonList"></datalist>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="teslimAlan" class="block text-sm font-medium text-gray-700 mb-1">Teslim Alan</label>
                        <input type="text" id="teslimAlan" list="teslimAlanList" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <datalist id="teslimAlanList"></datalist>
                    </div>
                    <div>
                        <label for="girisTarihi" class="block text-sm font-medium text-gray-700 mb-1">Giriş Tarihi *</label>
                        <input type="date" id="girisTarihi" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" required>
                    </div>
                </div>
            </form>

            <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-3">
                <button id="cancelButton" type="button" class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-md border border-gray-300 transition duration-200">
                    İptal
                </button>
                <button id="saveButton" type="submit" form="itemForm" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Kaydet
                </button>
            </div>
        </div>
    </div>

    <!-- Excel İçe Aktarma Modalı -->
    <div id="importModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 transform transition-all scale-95 opacity-0" id="importModalContent">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Excel İçe Aktar</h3>
                <button id="closeImportModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Excel Dosyası Seç</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                </div>
                
                <div id="columnMapping" class="hidden">
                    <h4 class="text-lg font-medium text-gray-900 mb-2">Sütun Eşleştirme</h4>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div class="font-medium text-sm">Excel Sütunu</div>
                            <div class="font-medium text-sm">Sistem Sütunu</div>
                        </div>
                        <!-- Dinamik olarak eşleştirme seçenekleri eklenecek -->
                    </div>
                </div>
                
                <div id="importPreview" class="hidden">
                    <h4 class="text-lg font-medium text-gray-900 mb-2">Önizleme</h4>
                    <div class="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <!-- Dinamik olarak sütun başlıkları eklenecek -->
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                                <!-- Dinamik olarak önizleme verileri eklenecek -->
                            </tbody>
                        </table>
                    </div>
                    <div id="importStats" class="mt-2 text-sm text-gray-600">
                        <!-- İçe aktarma istatistikleri burada gösterilecek -->
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-3">
                <button id="cancelImportButton" type="button" class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-md border border-gray-300 transition duration-200">
                    İptal
                </button>
                <button id="importButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 disabled:bg-blue-300 disabled:cursor-not-allowed" disabled>
                    İçe Aktar
                </button>
            </div>
        </div>
    </div>

    <!-- Bildirim Kutusu -->
    <div id="messageBox" class="fixed bottom-5 right-5 z-60 p-4 rounded-lg shadow-lg text-white transition-all transform translate-x-full duration-300 ease-in-out">
        <span id="messageText"></span>
    </div>

    <!-- Silme Onay Modalı -->
    <div id="confirmationModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 p-6 transform transition-all scale-95 opacity-0" id="confirmationContent">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Kaydı Sil</h3>
            <p class="text-sm text-gray-600 mb-6">Bu kaydı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancel" class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-md border border-gray-300 transition duration-200">
                    İptal
                </button>
                <button id="confirmDelete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Sil
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase modüllerini CDN'den import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc,
            deleteDoc,
            doc,
            setDoc, 
            onSnapshot,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ⚠️⚠️⚠️ KENDİ FIREBASE YAPILANDIRMANIZ ⚠️⚠️⚠️
        const firebaseConfig = {
            apiKey: "AIzaSyCCy9A4qXGln8WhDvLpBOVWx_nF3zWPgJ4",
            authDomain: "rossmann-envanter-sistemi.firebaseapp.com",
            projectId: "rossmann-envanter-sistemi",
            storageBucket: "rossmann-envanter-sistemi.firebasestorage.app",
            messagingSenderId: "1020061626010",
            appId: "1:1020061626010:web:f81e39cdbf6f0d4379b923"
        };
        // ⚠️⚠️⚠️ YAPILANDIRMA BİTTİ ⚠️⚠️⚠️

        // Global değişkenler
        let app, auth, db;
        let localInventory = [];
        let itemToDeleteId = null;
        let unsubscribe = null;
        let currentUser = null;
        let undoStack = [];
        let isGrouped = false;
        let currentFilters = {
            cihazTuru: [],
            durum: [],
            lokasyon: [],
            teslimAlan: []
        };

        // DOM Elementleri
        const loginScreen = document.getElementById('loginScreen');
        const appScreen = document.getElementById('appScreen');
        const currentUserElement = document.getElementById('currentUser');
        
        const statusBox = document.getElementById('statusBox');
        const connectionStatus = document.getElementById('connectionStatus');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const searchInput = document.getElementById('searchInput');
        const exportCsvButton = document.getElementById('exportCsvButton');
        const importExcelButton = document.getElementById('importExcelButton');
        const undoButton = document.getElementById('undoButton');
        
        // Filtre elementleri
        const filterButton = document.getElementById('filterButton');
        const advancedFilters = document.getElementById('advancedFilters');
        const filterCihazTuru = document.getElementById('filterCihazTuru');
        const filterDurum = document.getElementById('filterDurum');
        const filterLokasyon = document.getElementById('filterLokasyon');
        const filterTeslimAlan = document.getElementById('filterTeslimAlan');
        const groupByCihazTuru = document.getElementById('groupByCihazTuru');
        const clearFiltersButton = document.getElementById('clearFiltersButton');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        
        const itemModal = document.getElementById('itemModal');
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('modalTitle');
        const openModalButton = document.getElementById('openModalButton');
        const closeModalButton = document.getElementById('closeModalButton');
        const cancelButton = document.getElementById('cancelButton');
        const saveButton = document.getElementById('saveButton');
        const itemForm = document.getElementById('itemForm');

        const editingItemId = document.getElementById('editingItemId');
        const envanterNo = document.getElementById('envanterNo');
        const cihazTuru = document.getElementById('cihazTuru');
        const markaModel = document.getElementById('markaModel');
        const seriNo = document.getElementById('seriNo');
        const durum = document.getElementById('durum');
        const lokasyon = document.getElementById('lokasyon');
        const teslimAlan = document.getElementById('teslimAlan');
        const girisTarihi = document.getElementById('girisTarihi');

        // Otomatik tamamlama listeleri
        const envanterNoList = document.getElementById('envanterNoList');
        const cihazTuruList = document.getElementById('cihazTuruList');
        const markaModelList = document.getElementById('markaModelList');
        const seriNoList = document.getElementById('seriNoList');
        const lokasyonList = document.getElementById('lokasyonList');
        const teslimAlanList = document.getElementById('teslimAlanList');

        // Excel içe aktarma modalı
        const importModal = document.getElementById('importModal');
        const importModalContent = document.getElementById('importModalContent');
        const closeImportModalButton = document.getElementById('closeImportModalButton');
        const excelFile = document.getElementById('excelFile');
        const columnMapping = document.getElementById('columnMapping');
        const importPreview = document.getElementById('importPreview');
        const previewTableBody = document.getElementById('previewTableBody');
        const importStats = document.getElementById('importStats');
        const cancelImportButton = document.getElementById('cancelImportButton');
        const importButton = document.getElementById('importButton');

        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationContent = document.getElementById('confirmationContent');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmDelete = document.getElementById('confirmDelete');

        // Kullanıcı seçimi (Butonlardan çağrılır)
        window.loginAs = function(name) {
            currentUser = name;
            currentUserElement.textContent = currentUser;
            loginScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            initializeFirebase();
        };

        // Firebase başlatma
        function initializeFirebase() {
            try {
                // Firebase uygulamasını YALNIZCA burada başlat
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                connectionStatus.textContent = 'Kimlik doğrulanıyor...';
                setupAuth();
            } catch (error) {
                console.error('Firebase başlatma hatası:', error);
                updateStatus('error', 'Hata: Firebase yapılandırması geçersiz!');
                showMessage('Firebase yapılandırması hatalı. Lütfen firebaseConfig değerlerini kontrol edin.', true);
            }
        }

        // Kimlik doğrulama
        async function setupAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    updateStatus('success', 'Bağlı');
                    loadItems();
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error('Giriş hatası:', error);
                        updateStatus('error', 'Giriş başarısız');
                        showMessage('Kimlik doğrulama hatası: ' + error.message, true);
                    }
                }
            });
        }

        // Durum güncelle
        function updateStatus(type, message) {
            connectionStatus.textContent = message;
            statusBox.className = 'rounded px-3 py-2 text-sm';
            
            if (type === 'success') {
                statusBox.classList.add('bg-green-50', 'border', 'border-green-200');
                statusBox.innerHTML = `<i class="fas fa-check-circle text-green-600"></i> <span class="font-medium">Durum: </span><span class="font-mono">${message}</span>`;
            } else if (type === 'error') {
                statusBox.classList.add('bg-red-50', 'border', 'border-red-200');
                statusBox.innerHTML = `<i class="fas fa-exclamation-circle text-red-600"></i> <span class="font-medium">Durum: </span><span class="font-mono">${message}</span>`;
            } else {
                statusBox.classList.add('bg-yellow-50', 'border', 'border-yellow-200');
                statusBox.innerHTML = `<i class="fas fa-circle-notch fa-spin text-yellow-600"></i> <span class="font-medium">Durum: </span><span class="font-mono">${message}</span>`;
            }
        }

        // Verileri yükle (gerçek zamanlı)
        function loadItems() {
            try {
                const inventoryRef = collection(db, 'inventory');
                // createdAt'a göre sırala (yeni eklenen en üstte)
                const q = query(inventoryRef, orderBy('createdAt', 'desc')); 
                
                if (unsubscribe) {
                    unsubscribe(); // Önceki dinleyiciyi kaldır (varsa)
                }

                unsubscribe = onSnapshot(q, (snapshot) => {
                    localInventory = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Otomatik tamamlama listelerini güncelle
                    updateAutocompleteLists();
                    
                    // Filtre seçeneklerini güncelle
                    updateFilterOptions();
                    
                    // Arama kutusunda filtre varsa onu uygula, yoksa tümünü render et
                    filterTable(); 
                }, (error) => {
                    console.error('Veri dinleme hatası:', error);
                    showMessage('Veri yüklenemedi: ' + error.message, true);
                    inventoryTableBody.innerHTML = `<tr><td colspan="10" class="px-4 py-6 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Veri okuma başarısız! Firestore kurallarınızı kontrol edin.
                    </td></tr>`;
                });
            } catch (error) {
                console.error('Koleksiyon hatası:', error);
                showMessage('Veritabanı bağlantı hatası: ' + error.message, true);
            }
        }

        // Otomatik tamamlama listelerini güncelle
        function updateAutocompleteLists() {
            // Benzersiz değerleri topla
            const envanterNoValues = [...new Set(localInventory.map(item => item.envanterNo).filter(Boolean))];
            const cihazTuruValues = [...new Set(localInventory.map(item => item.cihazTuru).filter(Boolean))];
            const markaModelValues = [...new Set(localInventory.map(item => item.markaModel).filter(Boolean))];
            const seriNoValues = [...new Set(localInventory.map(item => item.seriNo).filter(Boolean))];
            const lokasyonValues = [...new Set(localInventory.map(item => item.lokasyon).filter(Boolean))];
            const teslimAlanValues = [...new Set(localInventory.map(item => item.teslimAlan).filter(Boolean))];
            
            // Listeleri güncelle
            updateDatalist(envanterNoList, envanterNoValues);
            updateDatalist(cihazTuruList, cihazTuruValues);
            updateDatalist(markaModelList, markaModelValues);
            updateDatalist(seriNoList, seriNoValues);
            updateDatalist(lokasyonList, lokasyonValues);
            updateDatalist(teslimAlanList, teslimAlanValues);
        }
        
        function updateDatalist(datalistElement, values) {
            datalistElement.innerHTML = '';
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                datalistElement.appendChild(option);
            });
        }

        // Filtre seçeneklerini güncelle
        function updateFilterOptions() {
            // Benzersiz değerleri topla
            const cihazTuruValues = [...new Set(localInventory.map(item => item.cihazTuru).filter(Boolean))];
            const lokasyonValues = [...new Set(localInventory.map(item => item.lokasyon).filter(Boolean))];
            const teslimAlanValues = [...new Set(localInventory.map(item => item.teslimAlan).filter(Boolean))];
            
            // Filtre seçeneklerini güncelle
            updateSelectOptions(filterCihazTuru, cihazTuruValues);
            updateSelectOptions(filterLokasyon, lokasyonValues);
            updateSelectOptions(filterTeslimAlan, teslimAlanValues);
        }
        
        function updateSelectOptions(selectElement, values) {
            // Mevcut seçili değerleri sakla
            const selectedValues = Array.from(selectElement.selectedOptions).map(option => option.value);
            
            selectElement.innerHTML = '';
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                // Eğer önceden seçiliyse tekrar seç
                if (selectedValues.includes(value)) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        // Form gönderme
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // Temel doğrulama
            if (!envanterNo.value || !girisTarihi.value) {
                showMessage('Lütfen * ile işaretli zorunlu alanları (Envanter No, Giriş Tarihi) doldurun.', true);
                return;
            }
            
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';

            // Temel veriler
            const itemData = {
                envanterNo: envanterNo.value,
                cihazTuru: cihazTuru.value,
                markaModel: markaModel.value,
                seriNo: seriNo.value,
                durum: durum.value,
                lokasyon: lokasyon.value,
                teslimAlan: teslimAlan.value,
                girisTarihi: girisTarihi.value,
                updatedAt: new Date().toISOString(),
                lastModifiedBy: currentUser // Her işlemde güncelleyen kişi değişir
            };

            try {
                const id = editingItemId.value;
                
                if (id) {
                    // Güncelleme
                    const itemRef = doc(db, 'inventory', id);
                    // Eski veriyi yığın için sakla
                    const oldItem = localInventory.find(item => item.id === id);
                    
                    await updateDoc(itemRef, itemData);
                    
                    // Geri alma için işlem kaydet
                    addToUndoStack({
                        type: 'update',
                        id: id,
                        data: oldItem // Geri almak için eski veriyi sakla
                    });
                    
                    showMessage('Kayıt güncellendi!', false);
                } else {
                    // Yeni kayıt
                    itemData.createdAt = new Date().toISOString();
                    itemData.createdBy = currentUser; // Sadece ilk oluştuğunda
                    const docRef = await addDoc(collection(db, 'inventory'), itemData);
                    
                    // Geri alma için işlem kaydet
                    addToUndoStack({
                        type: 'add',
                        id: docRef.id,
                        data: itemData
                    });
                    
                    showMessage('Kayıt eklendi!', false);
                }
                
                hideItemModal();
                itemForm.reset();
            } catch (error) {
                console.error('Kaydetme hatası:', error);
                showMessage('Hata: ' + error.message, true);
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = 'Kaydet';
            }
        }

        // Kayıt silme
        async function handleDeleteItem(id) {
            try {
                const itemToDelete = localInventory.find(item => item.id === id);
                await deleteDoc(doc(db, 'inventory', id));
                
                // Geri alma için işlem kaydet
                addToUndoStack({
                    type: 'delete',
                    id: id,
                    data: itemToDelete
                });
                
                showMessage('Kayıt silindi!', false);
            } catch (error) {
                console.error('Silme hatası:', error);
                showMessage('Silme hatası: ' + error.message, true);
            }
        }

        // Geri alma işlemi
        async function handleUndo() {
            if (undoStack.length === 0) return;
            
            const lastAction = undoStack.pop();
            
            try {
                switch (lastAction.type) {
                    case 'add':
                        // Ekleme işlemini geri al -> Yani yeni eklenen kaydı SİL
                        await deleteDoc(doc(db, 'inventory', lastAction.id));
                        showMessage('Ekleme işlemi geri alındı', false);
                        break;
                        
                    case 'delete':
                        // Silme işlemini geri al -> Yani silinen kaydı TEKRAR EKLE
                        // ÖNEMLİ DÜZELTME: addDoc yerine setDoc kullanıyoruz ki ID aynı kalsın!
                        const { id, ...dataToRestore } = lastAction.data;
                        // ID'si eski ID ile aynı olan bir döküman yarat/üzerine yaz
                        await setDoc(doc(db, 'inventory', lastAction.id), dataToRestore);
                        showMessage('Silme işlemi geri alındı', false);
                        break;
                        
                    case 'update':
                        // Güncellemeyi geri al -> Veriyi eski haline (lastAction.data) getir
                        // lastAction.data içinde eski veriler var
                        const { id: updateId, ...prevData } = lastAction.data;
                        await updateDoc(doc(db, 'inventory', lastAction.id), prevData);
                        showMessage('Güncelleme işlemi geri alındı', false);
                        break;
                }
                
                // Geri alma butonunu güncelle
                updateUndoButton();
            } catch (error) {
                console.error('Geri alma hatası:', error);
                showMessage('Geri alma hatası: ' + error.message, true);
            }
        }

        // Geri alma yığınına ekle
        function addToUndoStack(action) {
            undoStack.push(action);
            
            // Yığın boyutunu sınırla (son 10 işlem)
            if (undoStack.length > 10) {
                undoStack.shift();
            }
            
            // Geri alma butonunu güncelle
            updateUndoButton();
        }

        // Geri alma butonunu güncelle
        function updateUndoButton() {
            if (undoStack.length > 0) {
                undoButton.disabled = false;
                undoButton.title = `Son ${undoStack.length} işlemi geri al`;
            } else {
                undoButton.disabled = true;
                undoButton.title = 'Geri alınabilecek işlem yok';
            }
        }

        // Tabloyu oluştur
        function renderTable(items) {
            inventoryTableBody.innerHTML = '';

            if (items.length === 0) {
                // Arama sonucu mu boş, yoksa hiç veri mi yok?
                const isSearchEmpty = searchInput.value.trim().length > 0 || Object.values(currentFilters).some(arr => arr.length > 0);
                inventoryTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas ${isSearchEmpty ? 'fa-search' : 'fa-inbox'} fa-3x mb-3 text-gray-300"></i>
                            <p class="text-lg font-medium">${isSearchEmpty ? 'Aramanızla eşleşen kayıt bulunamadı' : 'Henüz kayıt bulunmuyor'}</p>
                            <p class="text-sm mt-1">${isSearchEmpty ? 'Farklı bir anahtar kelime deneyin veya filtreleri temizleyin' : 'Yeni kayıt eklemek için yukarıdaki butonu kullanın'}</p>
                        </td>
                    </tr>`;
                return;
            }

            // Gruplama özelliği aktif mi?
            if (isGrouped) {
                renderGroupedTable(items);
            } else {
                renderUngroupedTable(items);
            }

            addTableEventListeners();
        }

        // Gruplanmamış tablo
        function renderUngroupedTable(items) {
            items.forEach(item => {
                // İşlem yapanı belirle: Varsa son değiştiren, yoksa oluşturan
                const actorName = item.lastModifiedBy || item.createdBy || '-';
                
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors duration-150";
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-800 font-medium">${escapeHTML(item.envanterNo)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.cihazTuru)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.markaModel)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.seriNo)}</td>
                    <td class="px-4 py-3 text-sm"><span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusBadge(item.durum)}">${escapeHTML(item.durum)}</span></td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.lokasyon)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.teslimAlan)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${formatDate(item.girisTarihi)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700 font-medium text-blue-900">${escapeHTML(actorName)}</td>
                    <td class="px-4 py-3 text-sm text-center space-x-2">
                        <button data-id="${item.id}" class="edit-btn text-blue-600 hover:text-blue-800 transition-colors" title="Düzenle">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button data-id="${item.id}" class="delete-btn text-red-600 hover:text-red-800 transition-colors" title="Sil">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                inventoryTableBody.appendChild(tr);
            });
        }

        // Gruplanmış tablo
        function renderGroupedTable(items) {
            // Cihaz türlerine göre grupla
            const groupedItems = {};
            items.forEach(item => {
                const groupKey = item.cihazTuru || 'Belirtilmemiş';
                if (!groupedItems[groupKey]) {
                    groupedItems[groupKey] = [];
                }
                groupedItems[groupKey].push(item);
            });

            // Grupları render et
            Object.keys(groupedItems).forEach(groupKey => {
                const groupItems = groupedItems[groupKey];
                
                // Grup başlığı
                const groupHeader = document.createElement('tr');
                groupHeader.className = "group-header";
                groupHeader.innerHTML = `
                    <td colspan="10" class="px-4 py-3 text-sm font-medium text-gray-900">
                        <i class="fas fa-chevron-down mr-2"></i>
                        ${escapeHTML(groupKey)} (${groupItems.length} kayıt)
                    </td>
                `;
                inventoryTableBody.appendChild(groupHeader);
                
                // Grup içeriği
                const groupContent = document.createElement('tbody');
                groupContent.className = "group-content";
                
                groupItems.forEach(item => {
                    // İşlem yapanı belirle
                    const actorName = item.lastModifiedBy || item.createdBy || '-';

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors duration-150";
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-800 font-medium">${escapeHTML(item.envanterNo)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.cihazTuru)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.markaModel)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.seriNo)}</td>
                        <td class="px-4 py-3 text-sm"><span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusBadge(item.durum)}">${escapeHTML(item.durum)}</span></td>
                        <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.lokasyon)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.teslimAlan)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${formatDate(item.girisTarihi)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 font-medium text-blue-900">${escapeHTML(actorName)}</td>
                        <td class="px-4 py-3 text-sm text-center space-x-2">
                            <button data-id="${item.id}" class="edit-btn text-blue-600 hover:text-blue-800 transition-colors" title="Düzenle">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button data-id="${item.id}" class="delete-btn text-red-600 hover:text-red-800 transition-colors" title="Sil">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    groupContent.appendChild(tr);
                });
                
                inventoryTableBody.appendChild(groupContent);
                
                // Grup açma/kapama işlevi
                groupHeader.addEventListener('click', () => {
                    const icon = groupHeader.querySelector('i');
                    if (groupContent.classList.contains('hidden')) {
                        groupContent.classList.remove('hidden');
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-down');
                    } else {
                        groupContent.classList.add('hidden');
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-right');
                    }
                });
            });
        }

        // Tablodaki butonlara event listener ekle
        function addTableEventListeners() {
            inventoryTableBody.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => openEditModal(btn.dataset.id));
            });

            inventoryTableBody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => showDeleteConfirmation(btn.dataset.id));
            });
        }
        
        // Modal gösterme/gizleme fonksiyonları
        function showItemModal() {
            itemModal.classList.remove('hidden');
            setTimeout(() => {
                itemModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideItemModal() {
            itemModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                itemModal.classList.add('hidden');
                itemForm.reset(); // Formu her kapandığında temizle
                editingItemId.value = ''; // Düzenleme ID'sini temizle
            }, 300);
        }
        
        // Düzenleme modalını aç
        function openEditModal(id) {
            const item = localInventory.find(item => item.id === id);
            if (!item) {
                showMessage('Kayıt bulunamadı.', true);
                return;
            }

            modalTitle.textContent = 'Envanter Kaydını Düzenle';
            editingItemId.value = id;
            envanterNo.value = item.envanterNo || '';
            cihazTuru.value = item.cihazTuru || '';
            markaModel.value = item.markaModel || '';
            seriNo.value = item.seriNo || '';
            durum.value = item.durum || 'Yeni';
            lokasyon.value = item.lokasyon || '';
            teslimAlan.value = item.teslimAlan || '';
            girisTarihi.value = item.girisTarihi || '';
            
            showItemModal();
        }

        // Silme onayı modalı
        function showDeleteConfirmation(id) {
            itemToDeleteId = id;
            confirmationModal.classList.remove('hidden');
            setTimeout(() => {
                confirmationModal.classList.remove('opacity-0');
                confirmationContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideDeleteConfirmation() {
            confirmationModal.classList.add('opacity-0');
            confirmationContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                confirmationModal.classList.add('hidden');
                itemToDeleteId = null;
            }, 300);
        }

        // Excel içe aktarma modalı
        function showImportModal() {
            importModal.classList.remove('hidden');
            setTimeout(() => {
                importModal.classList.remove('opacity-0');
                importModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideImportModal() {
            importModal.classList.add('opacity-0');
            importModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                importModal.classList.add('hidden');
                // Modalı sıfırla
                excelFile.value = '';
                columnMapping.classList.add('hidden');
                importPreview.classList.add('hidden');
                importButton.disabled = true;
            }, 300);
        }

        // Excel dosyasını işle
        function handleExcelFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // İlk sayfayı al
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // JSON'a dönüştür
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showMessage('Excel dosyasında yeterli veri yok.', true);
                        return;
                    }
                    
                    // Sütun başlıklarını ve verileri ayır
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);
                    
                    // Sütun eşleştirme arayüzünü oluştur
                    createColumnMapping(headers, rows);
                    
                } catch (error) {
                    console.error('Excel işleme hatası:', error);
                    showMessage('Excel dosyası işlenirken hata oluştu: ' + error.message, true);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Sütun eşleştirme arayüzünü oluştur
        function createColumnMapping(excelHeaders, rows) {
            const systemFields = [
                { key: 'envanterNo', label: 'Envanter No', required: true },
                { key: 'cihazTuru', label: 'Cihaz Türü', required: false },
                { key: 'markaModel', label: 'Marka / Model', required: false },
                { key: 'seriNo', label: 'Seri No', required: false },
                { key: 'durum', label: 'Durum', required: false },
                { key: 'lokasyon', label: 'Lokasyon', required: false },
                { key: 'teslimAlan', label: 'Teslim Alan', required: false },
                { key: 'girisTarihi', label: 'Giriş Tarihi', required: true }
            ];
            
            let mappingHtml = '';
            systemFields.forEach(field => {
                mappingHtml += `
                    <div class="grid grid-cols-2 gap-2 items-center">
                        <div class="text-sm font-medium">${field.label}${field.required ? ' *' : ''}</div>
                        <div>
                            <select class="column-select w-full px-2 py-1 rounded border border-gray-300" data-field="${field.key}">
                                <option value="">-- Seçiniz --</option>
                                ${excelHeaders.map((header, index) => 
                                    `<option value="${index}">${header}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                `;
            });
            
            columnMapping.innerHTML = mappingHtml;
            columnMapping.classList.remove('hidden');
            
            // Önizleme oluştur
            createImportPreview(excelHeaders, rows);
            
            // Sütun seçimlerini dinle
            document.querySelectorAll('.column-select').forEach(select => {
                select.addEventListener('change', () => validateColumnMapping());
            });
        }

        // İçe aktarma önizlemesi oluştur
        function createImportPreview(headers, rows) {
            // Tablo başlıklarını oluştur
            let tableHtml = '<tr>';
            headers.forEach(header => {
                tableHtml += `<th class="px-3 py-2 text-left bg-gray-100 border-b">${escapeHTML(header)}</th>`;
            });
            tableHtml += '</tr>';
            
            // İlk 5 satırı göster
            const previewRows = rows.slice(0, 5);
            previewRows.forEach(row => {
                tableHtml += '<tr>';
                headers.forEach((_, index) => {
                    tableHtml += `<td class="px-3 py-1 border-b">${escapeHTML(row[index] || '')}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            previewTableBody.innerHTML = tableHtml;
            importPreview.classList.remove('hidden');
            
            // İstatistikleri göster
            importStats.textContent = `${rows.length} kayıt bulundu (ilk 5 gösteriliyor)`;
        }

        // Sütun eşleştirmesini doğrula
        function validateColumnMapping() {
            const requiredFields = ['envanterNo', 'girisTarihi'];
            const selectedFields = {};
            
            document.querySelectorAll('.column-select').forEach(select => {
                const field = select.dataset.field;
                const value = select.value;
                if (value !== '') {
                    selectedFields[field] = value;
                }
            });
            
            // Gerekli alanlar seçilmiş mi?
            const allRequiredSelected = requiredFields.every(field => selectedFields[field] !== undefined);
            
            // En az bir alan seçilmiş mi?
            const atLeastOneSelected = Object.keys(selectedFields).length > 0;
            
            importButton.disabled = !(allRequiredSelected && atLeastOneSelected);
        }

        // Excel verilerini içe aktar
        async function importExcelData() {
            const file = excelFile.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // İlk sayfayı al
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // JSON'a dönüştür
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showMessage('Excel dosyasında yeterli veri yok.', true);
                        return;
                    }
                    
                    // Sütun başlıklarını ve verileri ayır
                    const headers = jsonData[0];
                    const rows = jsonData.slice(1);
                    
                    // Sütun eşleştirmesini al
                    const columnMapping = {};
                    document.querySelectorAll('.column-select').forEach(select => {
                        const field = select.dataset.field;
                        const excelColumn = select.value;
                        if (excelColumn !== '') {
                            columnMapping[field] = parseInt(excelColumn);
                        }
                    });
                    
                    // Verileri işle
                    let successCount = 0;
                    let errorCount = 0;
                    const errors = [];
                    
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        try {
                            const itemData = {};
                            
                            // Eşleştirilmiş alanları doldur
                            Object.keys(columnMapping).forEach(field => {
                                const columnIndex = columnMapping[field];
                                if (columnIndex < row.length) {
                                    itemData[field] = row[columnIndex];
                                }
                            });
                            
                            // Tarih formatını düzelt
                            if (itemData.girisTarihi) {
                                itemData.girisTarihi = parseDate(itemData.girisTarihi);
                            }
                            
                            // Gerekli alanları kontrol et
                            if (!itemData.envanterNo || !itemData.girisTarihi) {
                                throw new Error(`Satır ${i+2}: Envanter No ve Giriş Tarihi zorunludur`);
                            }
                            
                            // Kullanıcı bilgilerini ekle
                            itemData.createdAt = new Date().toISOString();
                            itemData.createdBy = currentUser;
                            itemData.updatedAt = new Date().toISOString();
                            itemData.lastModifiedBy = currentUser;
                            
                            // Firestore'a ekle
                            await addDoc(collection(db, 'inventory'), itemData);
                            successCount++;
                            
                        } catch (error) {
                            errorCount++;
                            errors.push(`Satır ${i+2}: ${error.message}`);
                        }
                    }
                    
                    // Sonuçları göster
                    let message = `${successCount} kayıt başarıyla eklendi`;
                    if (errorCount > 0) {
                        message += `, ${errorCount} kayıt eklenemedi`;
                        console.error('İçe aktarma hataları:', errors);
                    }
                    
                    showMessage(message, errorCount > 0);
                    hideImportModal();
                    
                } catch (error) {
                    console.error('İçe aktarma hatası:', error);
                    showMessage('İçe aktarma sırasında hata oluştu: ' + error.message, true);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Tarih formatını ayrıştır
        function parseDate(dateString) {
            if (!dateString) return '';
            
            // Excel seri numarası (1900 tabanlı)
            if (typeof dateString === 'number') {
                const date = new Date((dateString - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            
            // String tarih
            const str = String(dateString).trim();
            
            // dd.MM.yyyy
            if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(str)) {
                const parts = str.split('.');
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            
            // dd/MM/yyyy
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(str)) {
                const parts = str.split('/');
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            
            // yyyy-MM-dd (zaten doğru format)
            if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(str)) {
                return str;
            }
            
            // Diğer formatlar için Date nesnesi kullan
            const date = new Date(str);
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0];
            }
            
            return str; // Dönüştürülemezse orijinal değeri döndür
        }

        // Filtreleme
        function filterTable() {
            let filteredItems = [...localInventory];
            
            // Metin araması
            const searchQuery = searchInput.value.toLowerCase().trim();
            if (searchQuery) {
                filteredItems = filteredItems.filter(item => {
                    return Object.values(item).some(value => 
                        String(value).toLowerCase().includes(searchQuery)
                    );
                });
            }
            
            // Gelişmiş filtreler
            if (currentFilters.cihazTuru.length > 0) {
                filteredItems = filteredItems.filter(item => 
                    currentFilters.cihazTuru.includes(item.cihazTuru)
                );
            }
            
            if (currentFilters.durum.length > 0) {
                filteredItems = filteredItems.filter(item => 
                    currentFilters.durum.includes(item.durum)
                );
            }
            
            if (currentFilters.lokasyon.length > 0) {
                filteredItems = filteredItems.filter(item => 
                    currentFilters.lokasyon.includes(item.lokasyon)
                );
            }
            
            if (currentFilters.teslimAlan.length > 0) {
                filteredItems = filteredItems.filter(item => 
                    currentFilters.teslimAlan.includes(item.teslimAlan)
                );
            }
            
            renderTable(filteredItems);
        }

        // Filtreleri uygula
        function applyFilters() {
            currentFilters.cihazTuru = Array.from(filterCihazTuru.selectedOptions).map(option => option.value);
            currentFilters.durum = Array.from(filterDurum.selectedOptions).map(option => option.value);
            currentFilters.lokasyon = Array.from(filterLokasyon.selectedOptions).map(option => option.value);
            currentFilters.teslimAlan = Array.from(filterTeslimAlan.selectedOptions).map(option => option.value);
            
            isGrouped = groupByCihazTuru.checked;
            
            filterTable();
        }

        // Filtreleri temizle
        function clearFilters() {
            searchInput.value = '';
            filterCihazTuru.selectedIndex = -1;
            filterDurum.selectedIndex = -1;
            filterLokasyon.selectedIndex = -1;
            filterTeslimAlan.selectedIndex = -1;
            groupByCihazTuru.checked = false;
            
            currentFilters = {
                cihazTuru: [],
                durum: [],
                lokasyon: [],
                teslimAlan: []
            };
            
            isGrouped = false;
            filterTable();
        }

        // Yardımcı Fonksiyonlar
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                // Tarihi 'yyyy-MM-dd' formatından ayır
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    // Tarayıcının local ayarını kullanmadan manuel formatla (dd.MM.yyyy)
                    return `${parts[2]}.${parts[1]}.${parts[0]}`;
                }
                // Eğer format beklenmedikse, tarayıcının insafına bırak
                const date = new Date(dateString);
                return date.toLocaleDateString('tr-TR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return dateString; // Hata olursa orijinal string'i döndür
            }
        }

        function getStatusBadge(status) {
            const badges = {
                'Yeni': 'bg-green-100 text-green-800',
                'Stokta': 'bg-green-100 text-green-800',
                'Kullanımda': 'bg-blue-100 text-blue-800',
                'Bakımda': 'bg-yellow-100 text-yellow-800',
                'Arızalı': 'bg-red-100 text-red-800'
            };
            return badges[status] || 'bg-gray-100 text-gray-800';
        }
        
        // CSV Dışa Aktar
        function exportToCSV() {
            if (localInventory.length === 0) {
                showMessage('Dışa aktarılacak veri yok.', true);
                return;
            }

            const headers = [
                'Envanter No', 'Cihaz Türü', 'Marka / Model', 'Seri No', 
                'Durum', 'Lokasyon', 'Teslim Alan', 'Giriş Tarihi', 'İşlem Yapan'
            ];
            // createdBy yerine lastModifiedBy'ı kontrol et, yoksa createdBy
            // Veriyi işlerken bu mantığı kuracağız
            
            // UTF-8 BOM (Byte Order Mark) ekleyerek Excel'in Türkçe karakterleri doğru açmasını sağla
            let csvContent = '\uFEFF';
            csvContent += headers.join(';') + '\n';

            localInventory.forEach(item => {
                const actorName = item.lastModifiedBy || item.createdBy || '-';
                
                const rowData = [
                    item.envanterNo,
                    item.cihazTuru,
                    item.markaModel,
                    item.seriNo,
                    item.durum,
                    item.lokasyon,
                    item.teslimAlan,
                    item.girisTarihi,
                    actorName
                ];

                const row = rowData.map(cell => {
                    let cellStr = (cell || '').toString();
                    cellStr = cellStr.replace(/"/g, '""'); // Çift tırnakları escape et
                    // Eğer hücre ; veya \n içeriyorsa çift tırnak içine al
                    if (cellStr.includes(';') || cellStr.includes('\n')) {
                        cellStr = `"${cellStr}"`;
                    }
                    return cellStr;
                });
                csvContent += row.join(';') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `envanter_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('CSV başarıyla dışa aktarıldı.', false);
        }

        // Bildirim Mesajı
        let messageTimeout;
        function showMessage(message, isError = false) {
            clearTimeout(messageTimeout);
            
            messageText.textContent = message;
            messageBox.className = 'fixed bottom-5 right-5 z-60 p-4 rounded-lg shadow-lg text-white transition-all transform duration-300 ease-in-out max-w-md';
            
            if (isError) {
                messageBox.classList.add('bg-red-600');
            } else {
                messageBox.classList.add('bg-green-600');
            }
            
            messageBox.classList.remove('translate-x-full');
            
            messageTimeout = setTimeout(() => {
                messageBox.classList.add('translate-x-full');
            }, 4000);
        }

        // Ana Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Giriş ekranını göster
            loginScreen.classList.remove('hidden');
        });
        
        openModalButton.addEventListener('click', () => {
            modalTitle.textContent = 'Yeni Envanter Kaydı';
            // Yeni kayıt modalını açarken bugünün tarihini otomatik ata
            girisTarihi.valueAsDate = new Date(); 
            showItemModal();
        });
        
        closeModalButton.addEventListener('click', hideItemModal);
        cancelButton.addEventListener('click', hideItemModal);

        itemModal.addEventListener('click', (e) => {
            if (e.target === itemModal) { // Modal'ın dışına tıklanırsa
                hideItemModal();
            }
        });
        
        confirmDelete.addEventListener('click', () => {
            if (itemToDeleteId) {
                handleDeleteItem(itemToDeleteId);
            }
            hideDeleteConfirmation();
        });
        
        confirmCancel.addEventListener('click', hideDeleteConfirmation);

        confirmationModal.addEventListener('click', (e) => {
            if (e.target === confirmationModal) { // Onay modalının dışına tıklanırsa
                hideDeleteConfirmation();
            }
        });

        itemForm.addEventListener('submit', handleFormSubmit);
        searchInput.addEventListener('input', filterTable); // Arama anlık filtreler
        exportCsvButton.addEventListener('click', exportToCSV);
        undoButton.addEventListener('click', handleUndo);
        
        // Filtre event listeners
        filterButton.addEventListener('click', () => {
            advancedFilters.classList.toggle('hidden');
        });
        
        applyFiltersButton.addEventListener('click', applyFilters);
        clearFiltersButton.addEventListener('click', clearFilters);
        
        // Excel içe aktarma event listeners
        importExcelButton.addEventListener('click', showImportModal);
        closeImportModalButton.addEventListener('click', hideImportModal);
        cancelImportButton.addEventListener('click', hideImportModal);
        excelFile.addEventListener('change', handleExcelFile);
        importButton.addEventListener('click', importExcelData);
        
        importModal.addEventListener('click', (e) => {
            if (e.target === importModal) { // Modal'ın dışına tıklanırsa
                hideImportModal();
            }
        });
    </script>

</body>
</html>
