<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesyonel Envanter Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Envanter Sistemi</h1>
                <p class="text-sm text-gray-500 mt-1">Rossmann Envanter Ve Stok Takip Sistemi</p>
            </div>
            <div class="text-xs text-gray-500 mt-2 sm:mt-0">
                <div id="statusBox" class="bg-yellow-50 border border-yellow-200 rounded px-3 py-2">
                    <i class="fas fa-circle-notch fa-spin text-yellow-600"></i>
                    <span class="font-medium">Durum: </span>
                    <span id="connectionStatus" class="font-mono">Bağlanıyor...</span>
                </div>
            </div>
        </header>

        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
            <div class="flex flex-col md:flex-row gap-3">
                <div class="relative flex-grow">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fas fa-search text-gray-400"></i>
                    </span>
                    <input type="search" id="searchInput" placeholder="Ara (Envanter No, Model, Seri No...)" class="w-full pl-10 pr-4 py-2.5 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200">
                </div>
                
                <div class="flex-shrink-0 flex gap-3">
                    <button id="exportCsvButton" class="w-full md:w-auto flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-md transition duration-200 shadow-sm">
                        <i class="fas fa-file-csv"></i>
                        <span>CSV Dışa Aktar</span>
                    </button>
                    <button id="openModalButton" class="w-full md:w-auto flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-md transition duration-200 shadow-sm">
                        <i class="fas fa-plus"></i>
                        <span>Yeni Kayıt Ekle</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full min-w-max table-auto">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Envanter No</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Cihaz Türü</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Marka / Model</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Seri No</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Durum</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Lokasyon</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Teslim Alan</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Giriş Tarihi</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Eylemler</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="9" class="px-4 py-6 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Veriler yükleniyor...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-4 text-center text-xs text-gray-500">
            <i class="fas fa-info-circle"></i> Bu sistem paylaşımlıdır. Tüm kullanıcılar verileri gerçek zamanlı olarak görür.
        </div>
    </div>

    <!-- Yeni Kayıt / Düzenleme Modalı -->
    <div id="itemModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 transform transition-all scale-95 opacity-0" id="modalContent">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900" id="modalTitle">Yeni Envanter Kaydı</h3>
                <button id="closeModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <form id="itemForm" class="p-6 space-y-4">
                <input type="hidden" id="editingItemId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="envanterNo" class="block text-sm font-medium text-gray-700 mb-1">Envanter No *</label>
                        <input type="text" id="envanterNo" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" required>
                    </div>
                    <div>
                        <label for="cihazTuru" class="block text-sm font-medium text-gray-700 mb-1">Cihaz Türü</label>
                        <input type="text" id="cihazTuru" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="markaModel" class="block text-sm font-medium text-gray-700 mb-1">Marka / Model</label>
                        <input type="text" id="markaModel" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label for="seriNo" class="block text-sm font-medium text-gray-700 mb-1">Seri No</label>
                        <input type="text" id="seriNo" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="durum" class="block text-sm font-medium text-gray-700 mb-1">Durum</label>
                        <select id="durum" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                            <option value="Yeni">Yeni</option>
                            <option value="Kullanımda">Kullanımda</option>
                            <option value="Arızalı">Arızalı</option>
                            <option value="Bakımda">Bakımda</option>
                            <option value="Stokta">Stokta</option>
                        </select>
                    </div>
                    <div>
                        <label for="lokasyon" class="block text-sm font-medium text-gray-700 mb-1">Lokasyon</label>
                        <input type="text" id="lokasyon" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="teslimAlan" class="block text-sm font-medium text-gray-700 mb-1">Teslim Alan</label>
                        <input type="text" id="teslimAlan" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label for="girisTarihi" class="block text-sm font-medium text-gray-700 mb-1">Giriş Tarihi *</label>
                        <input type="date" id="girisTarihi" class="w-full px-3 py-2 rounded-md border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" required>
                    </div>
                </div>
            </form>

            <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-3">
                <button id="cancelButton" type="button" class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-md border border-gray-300 transition duration-200">
                    İptal
                </button>
                <button id="saveButton" type="submit" form="itemForm" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Kaydet
                </button>
            </div>
        </div>
    </div>

    <!-- Bildirim Kutusu -->
    <div id="messageBox" class="fixed bottom-5 right-5 z-60 p-4 rounded-lg shadow-lg text-white transition-all transform translate-x-full duration-300 ease-in-out">
        <span id="messageText"></span>
    </div>

    <!-- Silme Onay Modalı -->
    <div id="confirmationModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 p-6 transform transition-all scale-95 opacity-0" id="confirmationContent">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Kaydı Sil</h3>
            <p class="text-sm text-gray-600 mb-6">Bu kaydı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancel" class="bg-white hover:bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-md border border-gray-300 transition duration-200">
                    İptal
                </button>
                <button id="confirmDelete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    Sil
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase modüllerini CDN'den import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc,
            deleteDoc,
            doc,
            onSnapshot,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ⚠️⚠️⚠️ KENDİ FIREBASE YAPILANDIRMANIZ ⚠️⚠️⚠️
        // Firebase yapılandırmanızı buraya yapıştırın.
        const firebaseConfig = {
            apiKey: "AIzaSyCCy9A4qXGln8WhDvLpBOVWx_nF3zWPgJ4",
            authDomain: "rossmann-envanter-sistemi.firebaseapp.com",
            projectId: "rossmann-envanter-sistemi",
            storageBucket: "rossmann-envanter-sistemi.firebasestorage.app",
            messagingSenderId: "1020061626010",
            appId: "1:1020061626010:web:f81e39cdbf6f0d4379b923"
        };
        // ⚠️⚠️⚠️ YAPILANDIRMA BİTTİ ⚠️⚠️⚠️

        // Global değişkenler
        let app, auth, db;
        let localInventory = [];
        let itemToDeleteId = null;
        let unsubscribe = null;

        // DOM Elementleri
        const statusBox = document.getElementById('statusBox');
        const connectionStatus = document.getElementById('connectionStatus');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const searchInput = document.getElementById('searchInput');
        const exportCsvButton = document.getElementById('exportCsvButton');
        
        const itemModal = document.getElementById('itemModal');
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('modalTitle');
        const openModalButton = document.getElementById('openModalButton');
        const closeModalButton = document.getElementById('closeModalButton');
        const cancelButton = document.getElementById('cancelButton');
        const saveButton = document.getElementById('saveButton');
        const itemForm = document.getElementById('itemForm');

        const editingItemId = document.getElementById('editingItemId');
        const envanterNo = document.getElementById('envanterNo');
        const cihazTuru = document.getElementById('cihazTuru');
        const markaModel = document.getElementById('markaModel');
        const seriNo = document.getElementById('seriNo');
        const durum = document.getElementById('durum');
        const lokasyon = document.getElementById('lokasyon');
        const teslimAlan = document.getElementById('teslimAlan');
        const girisTarihi = document.getElementById('girisTarihi');

        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationContent = document.getElementById('confirmationContent');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmDelete = document.getElementById('confirmDelete');

        // Firebase başlatma
        function initializeFirebase() {
            try {
                // Firebase uygulamasını YALNIZCA burada başlat
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                connectionStatus.textContent = 'Kimlik doğrulanıyor...';
                setupAuth();
            } catch (error) {
                console.error('Firebase başlatma hatası:', error);
                updateStatus('error', 'Hata: Firebase yapılandırması geçersiz!');
                showMessage('Firebase yapılandırması hatalı. Lütfen firebaseConfig değerlerini kontrol edin.', true);
            }
        }

        // Kimlik doğrulama
        async function setupAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    updateStatus('success', 'Bağlı');
                    loadItems();
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error('Giriş hatası:', error);
                        updateStatus('error', 'Giriş başarısız');
                        showMessage('Kimlik doğrulama hatası: ' + error.message, true);
                    }
                }
            });
        }

        // Durum güncelle
        function updateStatus(type, message) {
            connectionStatus.textContent = message;
            statusBox.className = 'rounded px-3 py-2';
            
            if (type === 'success') {
                statusBox.classList.add('bg-green-50', 'border', 'border-green-200');
                statusBox.innerHTML = `<i class="fas fa-check-circle text-green-600"></i> <span class="font-medium">Durum: </span><span class="font-mono">${message}</span>`;
            } else if (type === 'error') {
                statusBox.classList.add('bg-red-50', 'border', 'border-red-200');
                statusBox.innerHTML = `<i class="fas fa-exclamation-circle text-red-600"></i> <span class="font-medium">Durum: </span><span class="font-mono">${message}</span>`;
            } else {
                statusBox.classList.add('bg-yellow-50', 'border', 'border-yellow-200');
                statusBox.innerHTML = `<i class="fas fa-circle-notch fa-spin text-yellow-600"></i> <span class="font-medium">Durum: </span><span class="font-mono">${message}</span>`;
            }
        }

        // Verileri yükle (gerçek zamanlı)
        function loadItems() {
            try {
                const inventoryRef = collection(db, 'inventory');
                // createdAt'a göre sırala (yeni eklenen en üstte)
                const q = query(inventoryRef, orderBy('createdAt', 'desc')); 
                
                if (unsubscribe) {
                    unsubscribe(); // Önceki dinleyiciyi kaldır (varsa)
                }

                unsubscribe = onSnapshot(q, (snapshot) => {
                    localInventory = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Arama kutusunda filtre varsa onu uygula, yoksa tümünü render et
                    filterTable(); 
                }, (error) => {
                    console.error('Veri dinleme hatası:', error);
                    showMessage('Veri yüklenemedi: ' + error.message, true);
                    inventoryTableBody.innerHTML = `<tr><td colspan="9" class="px-4 py-6 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Veri okuma başarısız! Firestore kurallarınızı kontrol edin.
                    </td></tr>`;
                });
            } catch (error) {
                console.error('Koleksiyon hatası:', error);
                showMessage('Veritabanı bağlantı hatası: ' + error.message, true);
            }
        }

        // Form gönderme
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // Temel doğrulama
            if (!envanterNo.value || !girisTarihi.value) {
                showMessage('Lütfen * ile işaretli zorunlu alanları (Envanter No, Giriş Tarihi) doldurun.', true);
                return;
            }
            
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';

            const itemData = {
                envanterNo: envanterNo.value,
                cihazTuru: cihazTuru.value,
                markaModel: markaModel.value,
                seriNo: seriNo.value,
                durum: durum.value,
                lokasyon: lokasyon.value,
                teslimAlan: teslimAlan.value,
                girisTarihi: girisTarihi.value,
                updatedAt: new Date().toISOString()
            };

            try {
                const id = editingItemId.value;
                
                if (id) {
                    // Güncelleme
                    const itemRef = doc(db, 'inventory', id);
                    await updateDoc(itemRef, itemData);
                    showMessage('Kayıt güncellendi!', false);
                } else {
                    // Yeni kayıt
                    itemData.createdAt = new Date().toISOString(); // Sadece yeni kayıtta ekle
                    await addDoc(collection(db, 'inventory'), itemData);
                    showMessage('Kayıt eklendi!', false);
                }
                
                hideItemModal();
                itemForm.reset();
            } catch (error) {
                console.error('Kaydetme hatası:', error);
                showMessage('Hata: ' + error.message, true);
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = 'Kaydet';
            }
        }

        // Kayıt silme
        async function handleDeleteItem(id) {
            try {
                await deleteDoc(doc(db, 'inventory', id));
                showMessage('Kayıt silindi!', false);
            } catch (error) {
                console.error('Silme hatası:', error);
                showMessage('Silme hatası: ' + error.message, true);
            }
        }

        // Tabloyu oluştur
        function renderTable(items) {
            inventoryTableBody.innerHTML = '';

            if (items.length === 0) {
                // Arama sonucu mu boş, yoksa hiç veri mi yok?
                const isSearchEmpty = searchInput.value.trim().length > 0;
                inventoryTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas ${isSearchEmpty ? 'fa-search' : 'fa-inbox'} fa-3x mb-3 text-gray-300"></i>
                            <p class="text-lg font-medium">${isSearchEmpty ? 'Aramanızla eşleşen kayıt bulunamadı' : 'Henüz kayıt bulunmuyor'}</p>
                            <p class="text-sm mt-1">${isSearchEmpty ? 'Farklı bir anahtar kelime deneyin' : 'Yeni kayıt eklemek için yukarıdaki butonu kullanın'}</p>
                        </td>
                    </tr>`;
                return;
            }

            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors duration-150";
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-800 font-medium">${escapeHTML(item.envanterNo)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.cihazTuru)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.markaModel)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.seriNo)}</td>
                    <td class="px-4 py-3 text-sm"><span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusBadge(item.durum)}">${escapeHTML(item.durum)}</span></td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.lokasyon)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${escapeHTML(item.teslimAlan)}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">${formatDate(item.girisTarihi)}</td>
                    <td class="px-4 py-3 text-sm text-center space-x-2">
                        <button data-id="${item.id}" class="edit-btn text-blue-600 hover:text-blue-800 transition-colors" title="Düzenle">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button data-id="${item.id}" class="delete-btn text-red-600 hover:text-red-800 transition-colors" title="Sil">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                inventoryTableBody.appendChild(tr);
            });

            addTableEventListeners();
        }

        // Tablodaki butonlara event listener ekle
        function addTableEventListeners() {
            inventoryTableBody.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => openEditModal(btn.dataset.id));
            });

            inventoryTableBody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => showDeleteConfirmation(btn.dataset.id));
            });
        }
        
        // Modal gösterme/gizleme fonksiyonları
        function showItemModal() {
            itemModal.classList.remove('hidden');
            setTimeout(() => {
                itemModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideItemModal() {
            itemModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                itemModal.classList.add('hidden');
                itemForm.reset(); // Formu her kapandığında temizle
                editingItemId.value = ''; // Düzenleme ID'sini temizle
            }, 300);
        }
        
        // Düzenleme modalını aç
        function openEditModal(id) {
            const item = localInventory.find(item => item.id === id);
            if (!item) {
                showMessage('Kayıt bulunamadı.', true);
                return;
            }

            modalTitle.textContent = 'Envanter Kaydını Düzenle';
            editingItemId.value = id;
            envanterNo.value = item.envanterNo || '';
            cihazTuru.value = item.cihazTuru || '';
            markaModel.value = item.markaModel || '';
            seriNo.value = item.seriNo || '';
            durum.value = item.durum || 'Yeni';
            lokasyon.value = item.lokasyon || '';
            teslimAlan.value = item.teslimAlan || '';
            girisTarihi.value = item.girisTarihi || '';
            
            showItemModal();
        }

        // Silme onayı modalı
        function showDeleteConfirmation(id) {
            itemToDeleteId = id;
            confirmationModal.classList.remove('hidden');
            setTimeout(() => {
                confirmationModal.classList.remove('opacity-0');
                confirmationContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideDeleteConfirmation() {
            confirmationModal.classList.add('opacity-0');
            confirmationContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                confirmationModal.classList.add('hidden');
                itemToDeleteId = null;
            }, 300);
        }

        // Yardımcı Fonksiyonlar
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                // Tarihi 'yyyy-MM-dd' formatından ayır
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    // Tarayıcının local ayarını kullanmadan manuel formatla (dd.MM.yyyy)
                    return `${parts[2]}.${parts[1]}.${parts[0]}`;
                }
                // Eğer format beklenmedikse, tarayıcının insafına bırak
                const date = new Date(dateString);
                return date.toLocaleDateString('tr-TR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return dateString; // Hata olursa orijinal string'i döndür
            }
        }

        function getStatusBadge(status) {
            const badges = {
                'Yeni': 'bg-green-100 text-green-800',
                'Stokta': 'bg-green-100 text-green-800',
                'Kullanımda': 'bg-blue-100 text-blue-800',
                'Bakımda': 'bg-yellow-100 text-yellow-800',
                'Arızalı': 'bg-red-100 text-red-800'
            };
            return badges[status] || 'bg-gray-100 text-gray-800';
        }

        // Filtreleme
        function filterTable() {
            const query = searchInput.value.toLowerCase().trim();
            if (!query) {
                renderTable(localInventory); // Filtre yoksa tüm listeyi göster
                return;
            }

            const filteredItems = localInventory.filter(item => {
                // Tüm item özelliklerinde ara
                return Object.values(item).some(value => 
                    String(value).toLowerCase().includes(query)
                );
            });
            
            renderTable(filteredItems); // Filtrelenmiş listeyi göster
        }
        
        // CSV Dışa Aktar
        function exportToCSV() {
            if (localInventory.length === 0) {
                showMessage('Dışa aktarılacak veri yok.', true);
                return;
            }

            const headers = [
                'Envanter No', 'Cihaz Türü', 'Marka / Model', 'Seri No', 
                'Durum', 'Lokasyon', 'Teslim Alan', 'Giriş Tarihi'
            ];
            const keys = [
                'envanterNo', 'cihazTuru', 'markaModel', 'seriNo', 
                'durum', 'lokasyon', 'teslimAlan', 'girisTarihi'
            ];
            
            // UTF-8 BOM (Byte Order Mark) ekleyerek Excel'in Türkçe karakterleri doğru açmasını sağla
            let csvContent = '\uFEFF';
            csvContent += headers.join(';') + '\n';

            localInventory.forEach(item => {
                const row = keys.map(key => {
                    let cell = item[key] || '';
                    cell = cell.toString().replace(/"/g, '""'); // Çift tırnakları escape et
                    // Eğer hücre ; veya \n içeriyorsa çift tırnak içine al
                    if (cell.includes(';') || cell.includes('\n')) {
                        cell = `"${cell}"`;
                    }
                    return cell;
                });
                csvContent += row.join(';') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `envanter_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('CSV başarıyla dışa aktarıldı.', false);
        }

        // Bildirim Mesajı
        let messageTimeout;
        function showMessage(message, isError = false) {
            clearTimeout(messageTimeout);
            
            messageText.textContent = message;
            messageBox.className = 'fixed bottom-5 right-5 z-60 p-4 rounded-lg shadow-lg text-white transition-all transform duration-300 ease-in-out max-w-md';
            
            if (isError) {
                messageBox.classList.add('bg-red-600');
            } else {
                messageBox.classList.add('bg-green-600');
            }
            
            messageBox.classList.remove('translate-x-full');
            
            messageTimeout = setTimeout(() => {
                messageBox.classList.add('translate-x-full');
            }, 4000);
        }

        // Ana Event Listeners
        document.addEventListener('DOMContentLoaded', initializeFirebase);
        
        openModalButton.addEventListener('click', () => {
            modalTitle.textContent = 'Yeni Envanter Kaydı';
            // Yeni kayıt modalını açarken bugünün tarihini otomatik ata
            girisTarihi.valueAsDate = new Date(); 
            showItemModal();
        });
        
        closeModalButton.addEventListener('click', hideItemModal);
        cancelButton.addEventListener('click', hideItemModal);

        itemModal.addEventListener('click', (e) => {
            if (e.target === itemModal) { // Modal'ın dışına tıklanırsa
                hideItemModal();
            }
        });
        
        confirmDelete.addEventListener('click', () => {
            if (itemToDeleteId) {
                handleDeleteItem(itemToDeleteId);
            }
            hideDeleteConfirmation();
        });
        
        confirmCancel.addEventListener('click', hideDeleteConfirmation);

        confirmationModal.addEventListener('click', (e) => {
            if (e.target === confirmationModal) { // Onay modalının dışına tıklanırsa
                hideDeleteConfirmation();
            }
        });

        itemForm.addEventListener('submit', handleFormSubmit);
        searchInput.addEventListener('input', filterTable); // Arama anlık filtreler
        exportCsvButton.addEventListener('click', exportToCSV);
    </script>

</body>
</html>
